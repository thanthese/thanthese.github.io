<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Memorizer</title>
    <style>
        body {
            font-family: sans-serif;
        }

        #poem {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 2em 1em;
            font-size: 12pt;
            text-align: left;
            color: rgba(0, 0, 0, 0.8);
        }

        button {
            margin: 0.5em 0.5em 0 0;
            padding: 0.5em;
            font-size: 12pt;
        }

        #error {
            background-color: rgba(255, 0, 0, 0.5);
            color: black;
            padding: 1em;
        }
    </style>
</head>
<body>
<div id="poem-block">
    <div id="poem" onclick="action_nextChunk();"></div>
    <button onclick="action_editPoem();">Edit poem</button>
</div>
<div id="edit-block">
    <div id="error" style="display: none;">Enter poem below</div>
    <div>
        <textarea rows=10 cols=60 title="edit-poem" name="edit-poem" id="edit-poem"></textarea>
    </div>
    <button onclick="action_cancelEditPoem();">Cancel</button>
    <button onclick="action_saveNewPoem();">Save</button>
</div>
<button onclick="clearLocalStorage();" hidden>Clear localstorage</button>
<script>
    let chunks = [];

    function initApp() {
        history.pushState(null, "", "");
        window.onpopstate = function () {
            history.pushState(null, "", "");
            action_previousChunk();
        };
        if (!localStorage.poem || localStorage.poem.trim() === "") {
            hide("poem-block");
            show("edit-block");
            return;
        }
        setChunks(localStorage.poem);
        if (!localStorage.chunkId || localStorage.chunkId > chunks.length) {
            localStorage.chunkId = 0;
        }
        displayChunk();
    }

    function setChunks() {
        const lines = localStorage.poem.replace(/ /g, "&nbsp;").split("\n");
        chunks = [];
        for (let groupSize = 1; groupSize <= 6 && groupSize < lines.length; ++groupSize) {
            for (let i = 0; i < lines.length; i += groupSize) {
                chunks.push(makeChunk(lines.slice(i, i + groupSize)));
            }
        }
        chunks.push(makeChunk(lines));
    }

    function makeChunk(lines) {
        return lines.map(l => `&nbsp;${l}<br/>`).join("");
    }

    function action_nextChunk() {
        if (localStorage.chunkId < chunks.length - 1) {
            ++localStorage.chunkId;
            displayChunk();
        }
    }

    function action_previousChunk() {
        if (localStorage.chunkId > 0) {
            --localStorage.chunkId;
            displayChunk();
        }
    }

    function displayChunk() {
        show("poem-block");
        hide("edit-block");
        document.getElementById("poem").innerHTML = chunks[localStorage.chunkId];
    }

    function action_editPoem() {
        hide("poem-block");
        show("edit-block");
        document.getElementById("edit-poem").value = localStorage.poem;
    }

    function action_cancelEditPoem() {
        if (!localStorage.poem || localStorage.poem.trim() === "") {
            show("error");
            return;
        }
        show("poem-block");
        hide("edit-block");
    }

    function action_saveNewPoem() {
        if (document.getElementById("edit-poem").value.trim() === "") {
            show("error");
            return;
        }
        hide("error");
        localStorage.poem = document.getElementById("edit-poem").value;
        localStorage.chunkId = 0;
        setChunks();
        displayChunk();
    }

    function show(id) {
        document.getElementById(id).style.display = "";
    }

    function hide(id) {
        document.getElementById(id).style.display = "none";
    }

    function clearLocalStorage() {
        localStorage.chunkId = 0;
        localStorage.poem = "";
        initApp();
    }

    initApp();
</script>
</body>
</html>